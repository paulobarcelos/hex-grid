
<link rel="import" href="../polymer/polymer.html">

<dom-module id="hex-grid">
	<template>
		<style>
			:host {
				display: block;
				box-sizing: border-box;
				overflow: scroll;
				-webkit-overflow-scrolling: touch;
				
			}
			#container ::content > .item{
				position: absolute;
				overflow: hidden;
				box-sizing: border-box;

			}
			#container ::content > .item .inner{
				position: absolute;
				overflow: hidden;
				box-sizing: border-box;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				-webkit-clip-path: polygon(
					25% 0%,
					75% 0%,
					100% 50%,
					75% 100%,
					25% 100%,
					0% 50%,
					25% 0%
				);
			}
		</style>

		<div id="container">
			<content id="content" select=".item"></content>
		</div>

	</template>
</dom-module>

<script>

	Polymer({

		is: 'hex-grid',

		properties: {
			size: {
				type: Number
			},
			fitting: {
				type: Number
			},
			minScale: {
				type: Number
			},
			flatTopped: {
				type: Boolean,
				value: false
			},
			items:{
				type: Array
			}
		},
		attached: function(){
			this._layout();
		},
		listeners:{
			'scroll': '_onScroll'
		},
		observers:[
			'_layout(size, fitting, minScale)'
		],
		ready: function(){
			var observer = new MutationObserver(this._layout.bind(this));
			observer.observe(this, {
				childList: true,
				subtree: true,
				characterData: true
			});

			this._rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);

		},
		_layout: function(){
			var boundingRect = this.getBoundingClientRect();
			this._windowWidth = parseFloat(boundingRect.width / this._rootFontSize);
			this._windowHeight = parseFloat(boundingRect.height / this._rootFontSize);

			this.items = Polymer.dom(this.$.content).getDistributedNodes();
			if(!this.items.length){
				return;
			}
			var rows = Math.floor(Math.sqrt(this.items.length));
			var cols = Math.ceil(this.items.length / rows);

			var width = this.size * 2;
			var height = Math.sqrt(3)/2 * width;
			var horizontalSpace = width * 3/4;
			var verticalSpace = height;
			for (var x = 0; x < cols; x++) {
				for (var y = 0; y < rows; y++) {
					var index = (y*cols) + x;
					var item = this.items[index];
					if(index >= this.items.length){
						continue;
					}
					item.dataset.xIndex = x;
					item.dataset.yIndex = y;
					item.dataset.index = index;

					item.dataset.width = (width * this.fitting);
					item.dataset.height = (height * this.fitting);
					item.dataset.top = (y * verticalSpace + (x % 2) * height / 2);
					item.dataset.left = (x * horizontalSpace);

					item.style.width = item.dataset.width + 'rem';
					item.style.height = item.dataset.height + 'rem';
					item.style.top = item.dataset.top + 'rem';
					item.style.left = item.dataset.left + 'rem';

				}
			}
			this.$.container.style.width = ((cols - 1) * horizontalSpace + (width * 1-(3/4) ) * this.fitting) + 'rem';
			this.$.container.style.height = (verticalSpace * rows + verticalSpace / 2 - verticalSpace * (1-this.fitting))  + 'rem';
			this._onScroll();
		},
		_onScroll: function(){
			var scrollTop = this.scrollTop / this._rootFontSize;
			var scrollLeft =  this.scrollLeft / this._rootFontSize;
			this.items.forEach(function(item) {
				var distL = scrollLeft - item.dataset.left;
				var percentL = distL / item.dataset.width;

				var distT = scrollTop - item.dataset.top;
				var percentT = distT / item.dataset.height;

				var distB = parseFloat(item.dataset.top) + parseFloat(item.dataset.height) - (scrollTop + this._windowHeight);
				var percentB = distB / item.dataset.height;

				var distR = parseFloat(item.dataset.left) + parseFloat(item.dataset.width) - (scrollLeft + this._windowWidth);
				var percentR = distR / item.dataset.width;

				var biggestPercent = percentL;
				if(percentR > biggestPercent){
					biggestPercent = percentR;
				}
				if(percentB > biggestPercent){
					biggestPercent = percentB;
				}
				if(percentT > biggestPercent){
					biggestPercent = percentT;
				}

				var transformOriginLeft = '50%';
				if(percentL > 0){
					transformOriginLeft = '100%';
				}
				else if(percentR > 0){
					transformOriginLeft = '0%'
				}

				var transformOriginTop = '50%';
				if(percentT > 0){
					transformOriginTop = '100%';
				}
				else if(percentB > 0){
					transformOriginTop = '0%';
				}
				if(percentL > 0 && percentT > 0){
					transformOriginLeft = '75%';
				}
				if(percentL > 0 && percentB > 0){
					transformOriginLeft = '75%';
				}
				if(percentR > 0 && percentT > 0){
					transformOriginLeft = '25%';
				}
				if(percentR > 0 && percentB > 0){
					transformOriginLeft = '25%';
				}

				item.style.transformOrigin = transformOriginLeft + ' ' + transformOriginTop;

				var scale = 1;
				if(biggestPercent > 0 && biggestPercent < 1){
					scale = 1 - biggestPercent;
				}
				if(scale < this.minScale){
					scale = this.minScale;
				}
				this.transform('scale3d('+scale+','+scale+',1)', item);

			}.bind(this));
		}

	});

</script>
